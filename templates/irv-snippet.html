<style>
.greyedOut {
    color: darkgrey;
    background-color: lightgrey;
}
.highblue {
    background-color: #cceff6;
}
.highred {
    background-color: #ffeeee;
}
.highlight {
    background-color: #ffffdd;
}
.irv-colorblock {
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-right: 4px;
    vertical-align: middle;
    border: 1px solid #000;
    font-size: 0;
}
.irv-cell {
    position: relative;
}
.irv-transfer-indicator {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 16px;
    height: 8px;
    background-color: #333;
    border: 1px solid #666;
    cursor: pointer;
    border-radius: 2px;
}
.irv-transfer-indicator:hover {
    background-color: #555;
}
.irv-popover {
    position: absolute;
    background: white;
    border: 2px solid #333;
    border-radius: 4px;
    padding: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    z-index: 1000;
    min-width: 200px;
    max-width: 400px;
    font-size: 12px;
    line-height: 1.3;
    display: none;
    bottom: 20px;
    right: 0;
}
.irv-popover.show {
    display: block;
}

</style>
{% if scorestardict and scorestardict.starscale and scorestardict.starscale.colordict %}
<style>
  {% for cand, color in scorestardict.starscale.colordict.items() %}
  .irv-color-{{ loop.index }} { background-color: {{ color }}; }
  {% endfor %}
</style>
{% endif %}
<div>
  <ul>
    {% set has_tie = false %}
    {% set canddict = IRV_dict['canddict'] %}
    {% set winner = IRV_dict['winner'] %}
    {% set winnerstr = IRV_dict['winnerstr'] %}
    {% set winnerintro = "IRV/RCV Winners (tie)" if winner | length > 1 else "IRV/RCV Winner" %}
    {% set numrounds =  IRV_dict['rounds']|length %}
    {% set startingqty = IRV_dict['roundmeta'][0]['startingqty'] %}
    {% set majority = IRV_dict['roundmeta'][0]['startingqty'] // 2 + 1 %}

    {# Create color mapping for candidates #}
    {% set color_map = {} %}
    {% if scorestardict and scorestardict.starscale and scorestardict.starscale.colordict %}
      {% for cand, color in scorestardict.starscale.colordict.items() %}
        {% set _ = color_map.update({cand: loop.index}) %}
      {% endfor %}
    {% endif %}

    <li><b>{{winnerintro}}</b>:
      {% if winnerstr and IRV_candnames %}
        {%- set winner_tokens = winnerstr.split(',') -%}
        {%- for tok in winner_tokens -%}
          {{ IRV_candnames[tok.strip()] if tok.strip() in IRV_candnames else tok.strip() }}{% if not loop.last %}, {% endif %}
        {%- endfor -%}
      {% else %}
        {{ winnerstr }}
      {% endif %}
    </li>
    <li>Number of rounds: {{numrounds}}</li>
    <li>Total ballots: {{startingqty}}
    <li>Majority of ballots: {{majority}}
  </ul>
  <div class="hscroll">
  <table>
    <tr>
      {% for i in range(IRV_dict['rounds'] | length) %}
      <th>Round {{ i + 1 }}</th>
      {% endfor %}
    </tr>
    <tr>
      {% set flags = namespace(overvote=false) %}
      {% for i in range(IRV_dict['roundmeta'] | length) %}
      {% set round = IRV_dict['roundmeta'][i] %}
      <td><b>Overview</b>:<br>
        {% set threshold=round['countedqty'] // 2 + 1 %}
        <small>Starting ballots: {{round['startingqty'] }}<br/>
          Exhausted ballots:
                {{round['exhaustedqty'] }}<br>
          {% if round['overvoteqty'] > 0 %}
          Overvotes:
            {{round['overvoteqty'] }}<br>
          {% set flags.overvote=true %}
            {% endif %}
            Counted ballots: {{round['countedqty'] }}<br>
          {% if threshold < majority %}
          Minimum plurality: {{threshold}}<br/>
          {% endif %}
          {% if round['bottomtie'] %}
          TIE(†): {{ round['bottomtie'] | join(", ") }} <br/>
          {% endif %}
        </small>
      </td>
      {% endfor %}
    </tr>
    {% for cand in IRV_dict['rounds'][0].keys() %}
    {% if cand in winner %}
    {% set rowclass = "highlight" %}
    {% else %}
    {% set rowclass = "" %}
    {% endif %}
    <tr class="{{rowclass}}">
      {% for i in range(IRV_dict['rounds'] | length) %}
        {% set round_data = IRV_dict['rounds'][i] %}
        {% set round_meta = IRV_dict['roundmeta'][i] %}
        {% if cand in winner and (i + 1) == numrounds %}
          <td class="irv-cell"><b>IRV/RCV winner</b>:<br>
            {% if color_map.get(cand) %}<span class="irv-colorblock irv-color-{{ color_map[cand] }}"></span>{% endif %}
            {{ IRV_candnames.get(cand, cand) }}: {{ round_data.get(cand) }}
            {% set round = IRV_dict['roundmeta'][i] %}
            {% if round.transfers or round.hypothetical_transfers %}
              <div class="irv-transfer-indicator" onclick="toggleIrvPopover(this)"></div>
              <div class="irv-popover">
                {% include 'elim-pairwise-snippet.html' %}
              </div>
            {% endif %}
          </td>
        {% elif round_data.get(cand) and cand in round_meta.get('eliminated', []) %}
          <td class="highred irv-cell">
            {% if color_map.get(cand) %}<span class="irv-colorblock irv-color-{{ color_map[cand] }}"></span>{% endif %}
            {{ IRV_candnames.get(cand, cand) }}: {{ round_data.get(cand) }}
            {% if round_meta.get('batch_elim') %}
              (batch eliminated †)
            {% elif cand in round_meta.get('bottomtie', []) %}
              (randomly eliminated ††)
            {% else %}
              (eliminated)
            {% endif %}
            {% set round = IRV_dict['roundmeta'][i] %}
            {% if round.transfers or round.hypothetical_transfers %}
              <div class="irv-transfer-indicator" onclick="toggleIrvPopover(this)"></div>
              <div class="irv-popover">
                {% include 'elim-pairwise-snippet.html' %}
              </div>
            {% endif %}
          </td>
        {% elif round_data.get(cand) %}
          <td class="irv-cell">
            {% if color_map.get(cand) %}<span class="irv-colorblock irv-color-{{ color_map[cand] }}"></span>{% endif %}
            {{ IRV_candnames.get(cand, cand) }}: {{ round_data.get(cand) }}
            {% set round = IRV_dict['roundmeta'][i] %}
            {% if round.transfers or round.hypothetical_transfers %}
              <div class="irv-transfer-indicator" onclick="toggleIrvPopover(this)"></div>
              <div class="irv-popover">
                {% include 'elim-pairwise-snippet.html' %}
              </div>
            {% endif %}
          </td>
        {% else %}
          <td class="greyedOut irv-cell">
            {% if color_map.get(cand) %}<span class="irv-colorblock irv-color-{{ color_map[cand] }}" style="opacity: 0.5;"></span>{% endif %}
            <s>{{ IRV_candnames.get(cand, cand) }}</s>
          </td>
        {% endif %}
      {% endfor %}
    </tr>
    {% endfor %}
  </table>
  </div>
  {% for i in range(IRV_dict['roundmeta'] | length) %}
    {% set round = IRV_dict['roundmeta'][i] %}
    {% if round.elimcand_supporter_pairwise_results %}
      <h4>Pairwise preferences of voters for eliminated candidate(s) in Round {{ i + 1 }}</h4>
      {% include 'elim-pairwise-snippet.html' %}
    {% endif %}
  {% endfor %}
  {% if flags.overvote %}
  <p><small>Overvotes are ballots where multiple candidates are ranked at the same, highest-ranking position.</small></p>
  {% endif %}
  {% if IRV_dict['has_tie'] %}
  <span class="footnote">† - This example employs a limited form "batch elimination", where a batch of multiple candidates who (in sum total) do not have enough remaining top preferences to defeat the next highest candidate in the rankings.</span>
  <span class="footnote">†† - When a tie occurs, per the laws in the City and County of San Francisco and the laws in the state of Maine, the losing candidate for the round is randomly eliminated.</span>
  {% endif %}
 </div>
</div>

<script>
function toggleIrvPopover(indicator) {
    // Find the popover element - it should be the next sibling
    const popover = indicator.nextElementSibling;

    // Safety check - make sure we found the popover
    if (!popover || !popover.classList.contains('irv-popover')) {
        console.error('Could not find popover element');
        return;
    }

    // Close all other popovers first
    document.querySelectorAll('.irv-popover.show').forEach(otherPopover => {
        if (otherPopover !== popover) {
            otherPopover.classList.remove('show');
        }
    });

    // Toggle the clicked popover
    const isShowing = popover.classList.contains('show');
    if (isShowing) {
        popover.classList.remove('show');
    } else {
        popover.classList.add('show');

        // Add the outside click listener after a small delay to prevent immediate closing
        setTimeout(() => {
            const closeOnOutsideClick = (event) => {
                if (!indicator.contains(event.target) && !popover.contains(event.target)) {
                    popover.classList.remove('show');
                    document.removeEventListener('click', closeOnOutsideClick);
                }
            };
            document.addEventListener('click', closeOnOutsideClick);
        }, 100);
    }
}
</script>
